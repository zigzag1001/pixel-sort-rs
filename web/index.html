<!DOCTYPE html>

<body>

	<input type="file" id="upload" accept="image/*">
	<input type="range" id="threshold" min="0" max="255" value="128">
	<input type="range" id="angle" min="0" max="360" value="10">
	<input type="checkbox" id="invert">
	<input type="button" id="sort" value="Sort">
	<canvas id="canvas" style="max-width: 100%; max-height: 100%;"></canvas>

	<script type="module">

		const pixel_sort_rs = await import('./pkg/pixel_sort_rs.js');
		await pixel_sort_rs.default();
		var ogImage = new Image();

		function sort_image(ctx, ogImage) {
			if (!ogImage.src) return;
			const ogCanvas = document.createElement("canvas");
			const ogCtx = ogCanvas.getContext("2d");
			ogCanvas.width = ogImage.width;
			ogCanvas.height = ogImage.height;
			ogCtx.drawImage(ogImage, 0, 0);
			const ogImageData = ogCtx.getImageData(0, 0, ogImage.width, ogImage.height);

			const threshold = document.getElementById("threshold").value;
			const angle = document.getElementById("angle").value;
			const invert = document.getElementById("invert").checked;

			console.log(angle);
			const SortConfig = new pixel_sort_rs.SortConfig(
				ogImage.width,
				ogImage.height,
				threshold,
				angle,
				invert
			);
			const flippedData = pixel_sort_rs.sort(ogImageData.data, SortConfig);
			const outputImageData = new ImageData(
				new Uint8ClampedArray(flippedData),
				ogImage.width,
				ogImage.height
			);
			ctx.putImageData(outputImageData, 0, 0);
		}

		async function run() {

			const uploadInput = document.getElementById("upload");
			const canvas = document.getElementById("canvas");
			const ctx = canvas.getContext("2d");

			// Sort on button click
			const sortButton = document.getElementById("sort");
			sortButton.addEventListener("click", () => {
				sort_image(ctx, ogImage);
			});

			// Sort on file upload
			uploadInput.addEventListener("change", async (event) => {
				const file = event.target.files[0];
				if (!file) return;
				let threshold = document.getElementById("threshold").value;

				const reader = new FileReader();
				reader.onload = async function (e) {
					ogImage.src = e.target.result;
					ogImage.onload = async function () {
						canvas.width = ogImage.width;
						canvas.height = ogImage.height;

						sort_image(ctx, ogImage);
					};
				};
				reader.readAsDataURL(file);
			});
		}

		run();

	</script>

</body>
